<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mongo ERD Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        import elk from 'https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.3/dist/mermaid-layout-elk.esm.min.mjs';

        // Initialize Mermaid with ELK layout for better handling of large diagrams
        await mermaid.registerLayoutLoaders(elk);
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            maxTextSize: 100000,
            logLevel: 'error',
            securityLevel: 'loose',
            elk: {
                mergeEdges: true,
                nodePlacementStrategy: 'NETWORK_SIMPLEX'
            }
        });

        window.mermaidReady = true;
        window.mermaid = mermaid;
    </script>
    <!-- Pan/Zoom library -->
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        #diagramContainer {
            width: 100%;
            height: 600px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            position: relative;
        }

        #diagram {
            width: 100%;
            height: 100%;
        }

        pre {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }

        .zoom-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            gap: 5px;
            background: white;
            padding: 5px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #374151;
        }

        .zoom-btn:hover {
            background: #f3f4f6;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Mongo DB Schema</h1>
                <p class="text-gray-500">Auto-generated ERD with ELK Layout</p>
            </div>
            <div class="flex gap-3">
                <button id="showCodeBtn"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-6 rounded-lg shadow transition">
                    View Code
                </button>
                <button id="downloadBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg shadow transition">
                    Download PNG
                </button>
            </div>
        </header>

        <div id="errorBox" class="hidden bg-red-50 border border-red-200 text-red-800 p-4 rounded-lg mb-4">
            <h3 class="font-bold">Error Details:</h3>
            <pre id="errorText" class="text-sm mt-2"></pre>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <div id="loader" class="text-center py-12 text-gray-500">
                <p class="animate-pulse">Analyzing Database & Rendering ERD...</p>
                <p class="text-sm mt-2">Using ELK layout for optimal visualization</p>
            </div>
            <div id="diagramContainer" class="opacity-0 transition-opacity duration-500">
                <div id="diagram"></div>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomIn" title="Zoom In">+</button>
                    <button class="zoom-btn" id="zoomOut" title="Zoom Out">−</button>
                    <button class="zoom-btn" id="resetZoom" title="Reset">⟲</button>
                </div>
            </div>
        </div>

        <!-- Code Modal -->
        <div id="codeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Mermaid Code</h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <pre id="codeContent" class="text-sm overflow-auto flex-1"></pre>
                <div class="mt-4">
                    <p class="text-sm text-gray-600 mb-2">Copy this code and paste it into:</p>
                    <a href="https://mermaid.live" target="_blank"
                        class="text-blue-600 underline">https://mermaid.live</a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const diagramEl = document.getElementById('diagram');
        const diagramContainer = document.getElementById('diagramContainer');
        const loaderEl = document.getElementById('loader');
        const downloadBtn = document.getElementById('downloadBtn');
        const showCodeBtn = document.getElementById('showCodeBtn');
        const codeModal = document.getElementById('codeModal');
        const closeModal = document.getElementById('closeModal');
        const codeContent = document.getElementById('codeContent');
        const errorBox = document.getElementById('errorBox');
        const errorText = document.getElementById('errorText');

        let mermaidCode = '';
        let panZoomInstance = null;

        // Wait for Mermaid to be ready
        while (!window.mermaidReady) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        async function loadDiagram() {
            try {
                const response = await fetch('/erd');
                if (!response.ok) throw new Error('Failed to fetch ERD');

                const text = await response.text();
                mermaidCode = text;

                console.log('Received Mermaid code, length:', text.length);

                // Render with Mermaid (now using ELK layout)
                const { svg } = await window.mermaid.render('generatedDiagram', text);

                // Clear loader
                loaderEl.style.display = 'none';

                // Insert SVG
                diagramEl.innerHTML = svg;
                diagramContainer.classList.remove('opacity-0');

                // Initialize pan/zoom on the SVG
                const svgElement = diagramEl.querySelector('svg');
                if (svgElement) {
                    // Make SVG responsive
                    svgElement.style.width = '100%';
                    svgElement.style.height = '100%';

                    // SAVE ORIGINAL VIEWBOX FOR PNG EXPORT
                    // Store this before pan-zoom modifies anything
                    const originalViewBox = svgElement.getAttribute('viewBox');
                    svgElement.dataset.originalViewBox = originalViewBox;
                    console.log('Saved original viewBox for export:', originalViewBox);

                    panZoomInstance = svgPanZoom(svgElement, {
                        zoomEnabled: true,
                        controlIconsEnabled: false,
                        fit: true,
                        center: true,
                        minZoom: 0.1,
                        maxZoom: 10
                    });

                    // Wire up zoom controls
                    document.getElementById('zoomIn').onclick = () => panZoomInstance.zoomIn();
                    document.getElementById('zoomOut').onclick = () => panZoomInstance.zoomOut();
                    document.getElementById('resetZoom').onclick = () => {
                        panZoomInstance.reset();
                        panZoomInstance.fit();
                        panZoomInstance.center();
                    };
                }

                console.log('Diagram rendered successfully with ELK layout');

            } catch (err) {
                console.error('Error loading diagram:', err);

                // Show error
                loaderEl.style.display = 'none';
                errorBox.classList.remove('hidden');
                errorText.textContent = err.message + '\n\n' + (err.stack || '');
            }
        }

        showCodeBtn.addEventListener('click', () => {
            codeContent.textContent = mermaidCode;
            codeModal.classList.remove('hidden');
            codeModal.classList.add('flex');
        });

        closeModal.addEventListener('click', () => {
            codeModal.classList.add('hidden');
            codeModal.classList.remove('flex');
        });

        downloadBtn.addEventListener('click', async () => {
            const svg = diagramEl.querySelector('svg');
            if (!svg) {
                alert('No diagram to download.');
                return;
            }

            try {
                // Clone the SVG
                const svgClone = svg.cloneNode(true);

                // Use the ORIGINAL viewBox saved at render time
                const originalViewBox = svg.dataset.originalViewBox;
                if (!originalViewBox) {
                    alert('Original viewBox not found. Please refresh the page.');
                    return;
                }

                // Parse viewBox
                const [vbX, vbY, vbWidth, vbHeight] = originalViewBox.split(' ').map(parseFloat);

                // Add padding
                const padding = 50;
                const width = vbWidth + (padding * 2);
                const height = vbHeight + (padding * 2);
                const x = vbX - padding;
                const y = vbY - padding;

                console.log('Export using ORIGINAL viewBox:', { width, height, x, y });

                // Set proper viewBox to capture all content
                svgClone.setAttribute('viewBox', `${x} ${y} ${width} ${height}`);
                svgClone.setAttribute('width', width);
                svgClone.setAttribute('height', height);

                // Remove ALL transforms (pan-zoom state)
                svgClone.removeAttribute('transform');
                svgClone.querySelectorAll('g').forEach(g => {
                    g.removeAttribute('transform');
                });

                // Embed all styles inline
                const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
                styleElement.textContent = `
                    * {
                        font-family: Arial, Helvetica, sans-serif !important;
                    }
                    text {
                        font-family: Arial, Helvetica, sans-serif !important;
                        font-size: 14px;
                        fill: #000;
                    }
                    .er.entityBox {
                        fill: #f9f9f9;
                        stroke: #333;
                        stroke-width: 1px;
                    }
                    .er.relationshipLine {
                        stroke: #333;
                        stroke-width: 1.5px;
                        fill: none;
                    }
                    rect {
                        fill: #f9f9f9;
                        stroke: #333;
                    }
                    line, path {
                        stroke: #333;
                    }
                    .er.entityLabel {
                        fill: #000;
                        font-weight: bold;
                    }
                    .er.attributeBoxEven, .er.attributeBoxOdd {
                        fill: #fff;
                        stroke: #ddd;
                    }
                `;
                svgClone.insertBefore(styleElement, svgClone.firstChild);

                // Serialize
                const serializer = new XMLSerializer();
                let svgString = serializer.serializeToString(svgClone);

                if (!svgString.startsWith('<?xml')) {
                    svgString = '<?xml version="1.0" encoding="UTF-8"?>' + svgString;
                }
                if (!svgString.includes('xmlns="http://www.w3.org/2000/svg"')) {
                    svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }

                // ADAPTIVE SCALING: automatically adjust based on diagram size
                // Browser max canvas size is typically 32767x32767 or 16384x16384
                // Target max dimension: 12000px (safe for all browsers)
                const MAX_CANVAS_DIMENSION = 12000;
                const maxDimension = Math.max(width, height);

                // Calculate optimal scale
                let scale = 3; // Prefer 3x for quality
                if (maxDimension * scale > MAX_CANVAS_DIMENSION) {
                    scale = Math.floor(MAX_CANVAS_DIMENSION / maxDimension);
                }
                // Ensure at least 1.5x for minimum quality
                scale = Math.max(1.5, Math.min(3, scale));

                const canvas = document.createElement('canvas');
                canvas.width = Math.ceil(width * scale);
                canvas.height = Math.ceil(height * scale);

                console.log(`Using ${scale}x scale: ${canvas.width}x${canvas.height}px`);

                const ctx = canvas.getContext('2d', { alpha: false });

                // White background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.scale(scale, scale);

                // Render
                const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const reader = new FileReader();

                reader.onload = (e) => {
                    const img = new Image();

                    img.onload = () => {
                        try {
                            ctx.drawImage(img, 0, 0, width, height);

                            canvas.toBlob((blob) => {
                                if (!blob) {
                                    alert('Failed to create image');
                                    return;
                                }

                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.download = `mongo-erd-${Date.now()}.png`;
                                a.href = url;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);

                                setTimeout(() => URL.revokeObjectURL(url), 100);
                                console.log(`✅ PNG downloaded! ${canvas.width}x${canvas.height}px`);
                            }, 'image/png', 1.0);

                        } catch (err) {
                            console.error('Canvas error:', err);
                            alert('Failed: ' + err.message);
                        }
                    };

                    img.onerror = () => alert('Failed to load SVG');
                    img.src = e.target.result;
                };

                reader.onerror = () => alert('Failed to read SVG');
                reader.readAsDataURL(svgBlob);

            } catch (err) {
                console.error('Download error:', err);
                alert('Download failed: ' + err.message);
            }
        });

        // Load diagram on page ready
        loadDiagram();
    </script>
    <footer class="mt-8 text-center text-gray-400 text-sm">
        <p>Generated by <span class="font-mono text-gray-600">mongo-erd-generator</span></p>
    </footer>
</body>

</html>